---
title: "data_vis_practice"
author: "juho"
date: '2021 11 4 '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dslabs)
library(tidyverse)
library(ggplot2)
```

```{r}
data("gapminder")

gapminder=gapminder %>% as_tibble()
str(gapminder)
summary(gapminder)
```
# Han Rosling's quiz(1)
## 1
유아 사망률 비교 
```{r}
a=gapminder %>% 
  filter(year==2015) %>% 
  filter(country %in% c("Sri Lanka","Turkey")) %>% 
  select(country,infant_mortality)
a
```
## 2
기대 수명과 출산율(자녀 수)의 관계
```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility,life_expectancy))+
  geom_point()
```
<br><br>
1. 5 정도를 기점으로 두 그룹으로 나뉘는 것을 확인 할 수 있다.
2. 하지만 자녀수에 따른 기대 수명이 반비례 관계에 있다고 하기엔 부족한 감이 있다.
3. 조금 더 추가적인 분석이 필요하다.(각 점이 무슨 대륙 or 나라를 뜻 하는지 등등)
```{r}
gapminder %>% 
  filter(year == 1962) %>% 
  ggplot(aes(fertility,life_expectancy,color=continent))+
  geom_point()
```
<br><br>

유럽과 아프리카는 확실하게 두 그룹으로 분류 되는 것을 확인 할 수 있다.
아메리카와 아시아는 두 그룹에 모두 속하게 나뉘어져 있다.

### facet_grid
두 개의 그래프를 비교하기 위하여 사용하는 option
#### faceting을 이용하여 2012년도와 1962년도를 비교해보자
```{r}
gapminder %>% 
  filter(year%in%c(1962,2012)) %>% 
  ggplot(aes(fertility,life_expectancy,col=continent))+
  geom_point() +
  facet_grid(continent~year)
```

<br><br>
대부분 그래프가 오른쪽에서 왼쪽으로 이동한 경향을 보이고 있다
=> 기대수명이 증가하고 출산율이 떨어지고 있다.
### continent 없이 x축으로만 facet하고 싶을 때
```{r}
gapminder %>% 
  filter(year%in%c(1962,2012)) %>% 
  ggplot(aes(fertility,life_expectancy,col=continent))+
  geom_point() +
  facet_grid(~year)
```
<br><br>

2012년이 되면서 조금 더 확실한 음의 관계를 보여주고 있다.
### facet_wrap
facet_grid와 비슷하나 살짝 다름
scales="free"를 활용하여 모든 그래프의 x,y축의 통일된 범위를 조금 더 보기 좋게 조정 할 수 있음
**x,y축만 바꾸려면 free_x or free_y**
=> 이걸 안 쓰면 그래프끼리 비교가 쉬워짐 but data point를 자세히 볼 수 있음
```{r}
years = c(1962,1980,1990,2000,2012)
continents = c("Europe","Asia")
gapminder %>% 
  filter(continent %in% continents) %>% 
  filter(year %in% years) %>% 
  ggplot(aes(fertility,life_expectancy,col=continent))+
  geom_point()+
  facet_wrap(~year)
```
```{r}
years = c(1962,1980,1990,2000,2012)
continents = c("Europe","Asia")
gapminder %>% 
  filter(continent %in% continents) %>% 
  filter(year %in% years) %>% 
  ggplot(aes(fertility,life_expectancy,col=continent))+
  geom_point()+
  facet_wrap(~year,scales="free")
```
```{r}
years = c(1962,1980,1990,2000,2012)
continents = c("Europe","Asia")
gapminder %>% 
  filter(continent %in% continents) %>% 
  filter(year %in% years) %>% 
  ggplot(aes(fertility,life_expectancy,col=continent))+
  geom_point()+
  facet_wrap(~year,scales="free_x")
```
<br><br>

#### 번외로 2012년도에 유럽보다 더 왼쪽에 있는 2나라 찾기
```{r}
con = gapminder %>% 
  filter(continent %in% c("Asia","Europe")) %>% 
  group_by(continent) %>% 
  summarize(min = min(fertility,na.rm=T)) %>% 
  select(min)
e_min = as.double(con[2,])
country = gapminder %>% 
  filter(continent %in% c("Asia")) %>%
  filter(year == 2012) %>% 
  filter(fertility<e_min) %>% 
  arrange(desc(life_expectancy))
country$fertility<3
```
# Time Series plot(시계열)
## 미국의 출산율
```{r}
gapminder %>%
  filter(country=="United States") %>% 
  ggplot(aes(year,fertility)) + 
  geom_point()
```
<br><br>

**이렇게 간격이 규칙적인 경우 선으로 연결하여 봄**
```{r}
gapminder %>% 
  filter(country=="United States") %>% 
  ggplot(aes(year,fertility)) +
  geom_line()
```
<br><br>

## 한국과 독일의 출산율
```{r}
countries = c("South Korea","Germany")

gapminder %>% 
  filter(country %in% countries) %>% 
  ggplot(aes(year,fertility))+
  geom_line()
```
<br><br>

### ggplot(group=)
위의 그래프는 우리가 원하는 그래프가 아니다 즉 **개별적인 그래프**를 그리고 싶은데 이 떄 쓰는게 group!
```{r}
countries = c("South Korea","Germany")

gapminder %>% 
  filter(country %in% countries & !is.na(fertility)) %>% 
  ggplot(aes(year,fertility,group=country))+
  geom_line(aes(color=country))
```
<br><br>

### color로 그룹 만들기
group으로 해도되지만 이렇게 컬러로 묶어주면 자동적으로 나뉨
```{r}
countries = c("South Korea","Germany")

gapminder %>% 
  filter(country %in% countries & !is.na(fertility)) %>% 
  ggplot(aes(year,fertility))+
  geom_line(aes(color=country))#위의 ggplot안에다가 넣어도 됨
```
<br><br>

### legend가 아닌 그래프 위에 직접적으로 label을 표시하기
```{r}
labels = data.frame(country=countries,x=c(1975,1965),y=c(60,72))#x,y는 label의 x좌표와 y좌표를 말해 줌

gapminder %>% 
  filter(country %in% countries & !is.na(fertility)) %>% 
  ggplot(aes(year,life_expectancy,color=country))+
  geom_line()+
  geom_text(data=labels,aes(x,y,label=country),size=5)+
  #geom_text는 x,y값으로 좌표를 입력받음 이 값이 labels의 x,y이기에 aes(x,y)하면 되는 것
  theme(legend.position = "None")
```
# Han Rosling's quiz(2)
## 부의 양극화는 심해지고 있는가?
만약 수입이 2$미만이라면 가난하다고 판단한다
```{r}
gapminder=gapminder %>% 
  mutate(dollars_per_day = gdp/population/365)

names(gapminder)
```

### 1970년대 부의 분포에 대하여 분포 확인
```{r}
past_year = 1970
gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>% 
  ggplot(aes(dollars_per_day))+
  geom_histogram(binwidth=1,color="black")#여기선 상자 외곽 즉 경계를 검정색으로 함으로써 구분을 확실하게 해줌
```
<br><br>

### 1970년대와 2010년대 비교
```{r}
past_year = 1970
gapminder %>% 
  filter(year %in% c(1970,2010) & !is.na(gdp)) %>% 
  ggplot(aes(dollars_per_day))+
  geom_histogram(binwidth=1,color="black")+
  facet_grid(~year,scale="free")
```
<br><br>

### 미국 중국 한국 비교
```{r}
gapminder %>% 
  filter(year %in% c(1970,2010) & !is.na(gdp) & country %in% c("United States","South Korea","China")) %>% 
  ggplot(aes(year,dollars_per_day,color=country))+
  geom_line()
```
<br><br>

## log transformation
만약 $1 극가난 $2 많이 가난 $4 가난 $8 중간 이런식으로 구분하려고 할 때 log_2를 취해주면 해석이 용이해 진다(hist에서 x값이 0이면 극가난,1이면 많이 가난,2면 가난 이런식으로 해석이 가능해지니까)
=> **log변환을 할 땐 이렇게 적절한 이유가 있어야 그 변환을 취했을 때 해석을 이끌어 낼 수 있음**
```{r}
gapminder %>% 
  filter(year==past_year & !is.na(gdp)) %>% 
  ggplot(aes(log2(dollars_per_day)))+
  geom_histogram(binwidth = 1,color="black")
```
<br><br>

위에 설명한 것처럼 log변환은 그 이유가 적절해야하고 그 이유에 따라 log의 base가 결정된다
=> 그렇기에 ln은 자주 쓰이지 않는다(그 의미가 애매...)

```{r}
a=gapminder %>% 
  filter(year==past_year) %>% 
  summarise(min=min(population),max=max(population))
a
```
이렇게 pop처럼 값이 너무 큰 경우 log10을 통하여 그 간격을 줄여서 볼 필요가 있음

```{r}
gapminder %>% 
  filter(year==past_year) %>% 
  ggplot(aes(log(population)))+
  geom_histogram(binwidth=0.5,color="black")

gapminder %>% 
  filter(year==past_year) %>% 
  ggplot(aes(log2(population)))+
  geom_histogram(binwidth=0.5,color="black")
```
<br><br>

=>log10을 취해준 것이 조금 더 의미가 명확하다

### scale_x_continuous
그래프에서만 log변환을 해서 보여주고 싶을 때
```{r}
gapminder %>% 
  filter(year==past_year) %>% 
  ggplot(aes((population)))+
  geom_histogram(binwidth=0.5,color="black")+
  scale_x_continuous(trans="log")
```
<br><br>

### 위의 부의 분배 hist를 지역별로 표시
```{r}
gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>% 
  mutate(region=reorder(region,dollars_per_day,FUN=median)) %>% #region을 dollar의 median값으로 재정렬 함
  ggplot(aes(dollars_per_day,region))+
  geom_point()+
  scale_x_continuous(trans="log2")
```
<br><br>

## Ridge plot 활용하기
여러개의 plot을 조금 더 다채롭게 겹쳐서 그리는 방법
### 새롭게 지역을 분류해서 그래프를 그려보자
```{r}
gapminder <- gapminder %>%
  mutate(group = case_when(
  region %in% c("Western Europe", "Northern Europe",
  "Southern Europe", "Northern America",
  "Australia and New Zealand") ~ "West",
  region %in% c("Eastern Asia",
  "South-Eastern Asia") ~ "East Asia",
  region %in% c("Caribbean", "Central America",
  "South America") ~ "Latin America",
  continent == "Africa" &
  region != "Northern Africa" ~ "Sub-Saharan",
  TRUE ~ "Others"))

gapminder = gapminder %>% 
  mutate(group = factor(group,levels=c("Others","Latin America","East Asia","Sub-Saharan","West")))
```
#### boxplot 그려보기
```{r}
p=gapminder %>% 
  filter(year==past_year & !is.na(gdp)) %>% 
  ggplot(aes(group,dollars_per_day))+
  geom_boxplot()+
  scale_y_continuous(trans="log2")+
  xlab("")+#x축 이름
  theme(axis.text.x=element_text(angle=90,hjust=1))#x축의 이름들을 세로로 변경
p
```
```{r}
p+geom_point(alpha=0.5)
```
```{r}
library(ggridges)
```
### Ridge plot
```{r}
p = gapminder %>% 
  filter(year==past_year & !is.na(gdp)) %>% 
  ggplot(aes(dollars_per_day,group))+
  scale_x_continuous(trans="log2")

p+geom_density_ridges()
```
<br><br>

#### Jittered_points
```{r}
p +
  geom_density_ridges(jittered_points = TRUE)
```
<br><br>

=> y값은 큰 의미가 없음

#### _rug representation_
data point표현을 이렇게 할 수도 있음
```{r}
p+geom_density_ridges(jittered_points = T,
                      position=
                        position_points_jitter(height=0),
                      point_shape='l',point_size=3,
                      point_alpha= 1, alpha=1)
```
```{r}
past_year = 1970
present_year = 2010
years = c(past_year,present_year)
gapminder %>% 
  filter(year %in% years & !is.na(gdp)) %>% 
  mutate(west = ifelse(group=="West","West","Developing")) %>% #ifelse(조건,True일 때,False일 때)
  ggplot(aes(dollars_per_day))+
  geom_histogram(binwidth=1,color="black")+
  scale_x_continuous(trans="log2")+
  facet_grid(year~west)
```
<br><br>

### intersect
집단1과 집단2의 교집합을 구하는 함수
=> 1970년대와 2010년도에 존재하는 나라는 다르기에 공통으로 존재한 나라들에 대해서 비교해보자
```{r}
country_list_1 = gapminder %>% 
  filter(year==past_year & !is.na(dollars_per_day)) %>% 
  pull(country)

country_list_2 = gapminder %>% 
  filter(year==present_year & !is.na(dollars_per_day)) %>% 
  pull(country)

country_list=intersect(country_list_1,country_list_2)
```

```{r}
gapminder %>% 
  filter(year %in% years & !is.na(gdp) & country %in% country_list) %>%
  mutate(west = ifelse(group == "West","West","Developing")) %>% 
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1,color="black")+
  scale_x_continuous(trans="log2")+
  facet_grid(year~west)
         
```
<br><br>

### boxplot여러 개 보기
```{r}
gapminder %>% 
  filter(year%in%years & !is.na(gdp)) %>% 
  ggplot(aes(group,dollars_per_day))+
  geom_boxplot()+
  scale_y_continuous(trans="log2")+
  xlab("")+#x축 이름
  theme(axis.text.x=element_text(angle=90,hjust=1))+#x축의 이름들을 세로로 변경
  facet_grid(~year)

```
<br><br>

### year를 factor로 보고 그래프 그려보기
```{r}
gapminder %>% 
  filter(year %in% years & country %in% country_list & !is.na(gdp)) %>%
  mutate(year=factor(year)) %>% 
  ggplot(aes(group,dollars_per_day,fill=year))+
  #만약 year가 numeric상태였다면 fill에서 인식하지 못 함
  geom_boxplot()+
  scale_y_continuous(trans="log2")+
  xlab("")
```
<br><br>

## Density 그래프 그리기
```{r}
gapminder %>% 
  filter(year %in% years & !is.na(gdp) & country %in% country_list) %>% 
  ggplot(aes(dollars_per_day))+
  geom_density(fill='grey')+
  scale_x_continuous(trans="log2")+
  facet_grid(~year)
```
<br><br>

#### 가난->부자,부자->가난 있는가?
```{r}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>% 
  mutate(group = ifelse(group=="West","West","Developing")) %>% 
  ggplot(aes(dollars_per_day,fill=group)) +
  geom_density(alpha=.5)+
  scale_x_continuous(trans="log2")+
  facet_grid(year~.)
```
<br><br>

#### 만약 Density그래프에서 y축을 count로 바꾸기
=>하지만 Density가 아니기에 비교하기 약간 애매함
(Developing의 수가 당연히 더 많기 때문에)
```{r}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>% 
  mutate(group = ifelse(group=="West","West","Developing")) %>% 
  ggplot(aes(dollars_per_day,fill=group,y=..count..)) +
  #이렇게 바꿔주면 된다
  geom_density(alpha=.5)+
  scale_x_continuous(trans="log2")+
  facet_grid(year~.)
```
<br><br>

### ridges를 활용,그룹별로 보기
```{r}
gapminder %>% 
  filter(year %in% years & !is.na(dollars_per_day)) %>% 
  ggplot(aes(dollars_per_day,group))+
  scale_x_continuous(trans="log2")+
  geom_density_ridges(adjust=1.5)+#adjust는 딱히 차이점을 모르겠다
  facet_grid(~year)
```
<br><br>

### Stacking하기
그래프를 위로 쌓아올리는 방법
단 여기서 두께만 그 수치를 나타내므로 주의해야함 높이가 아님
```{r}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>% 
  group_by(year) %>%# 왜
  mutate(weight=population/sum(population)*2) %>%# 있는
  ungroup() %>%#거지
  ggplot(aes(dollars_per_day,fill=group))+
  scale_x_continuous(trans="log2",limit=c(0.125,300))+
  geom_density(alpha=0.2,bw=0.75,position="stack")+
  facet_grid(year~.)
```
## r-graph-gallery.com 참고



















































































